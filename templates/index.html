<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Generator Prime</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="animated-bg"></div>
    <div class="glass-container">
        <header>
            <h1>Lead <span class="gradient-text">Generator</span></h1>
            <p class="subtitle">Extract high-quality business leads effortlessly</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="tab-extract">1. Business Leads</button>
            <button class="tab-btn" data-tab="tab-linkedin">2. LinkedIn Leads</button>
            <button class="tab-btn" data-tab="tab-analyze">3. Analyze Websites</button>
        </div>

        <!-- TAB 1: EXTRACT LEADS -->
        <div id="tab-extract" class="tab-content active">
            <form id="leadForm">
                <div class="row">
                    <div class="input-group">
                        <label for="keyword">Keyword / Niche</label>
                        <input type="text" id="keyword" name="keyword" placeholder="e.g. Gym equipment" required>
                    </div>

                    <div class="input-group">
                        <label for="apiKey">SerpAPI Key (Optional)</label>
                        <input type="text" id="apiKey" name="apiKey" placeholder="Leave empty to use default key">
                    </div>
                </div>

                <div class="row">
                    <div class="input-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" placeholder="e.g. Mumbai" required>
                    </div>

                    <div class="input-group">
                        <label for="limit">Target Limit</label>
                        <input type="number" id="limit" name="limit" value="10" min="1" max="500" required>
                    </div>
                </div>

                <div class="options-group"
                    style="display: flex; gap: 1rem; margin-bottom: 1.5rem; color: var(--text-secondary);">
                    <label
                        style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.95rem; font-weight: 400; margin: 0;">
                        <input type="checkbox" id="requireWebsite"
                            style="width: 18px; height: 18px; cursor: pointer; padding: 0;">
                        Must have Website
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.95rem; font-weight: 400; margin: 0;">
                        <input type="checkbox" id="requireEmail"
                            style="width: 18px; height: 18px; cursor: pointer; padding: 0;">
                        Must have Email
                    </label>
                </div>

                <button type="submit" id="generateBtn">
                    <span class="btn-text" id="btnText">Extract Leads</span>
                    <span class="btn-loader loader" id="btnLoader"></span>
                </button>
            </form>
        </div>

        <!-- TAB 2: LINKEDIN LEADS -->
        <div id="tab-linkedin" class="tab-content">
            <div class="info-box" style="border-left-color: #0077b5;">
                <p><strong>AI Smart Campaign:</strong> Describe your target audience in plain English. Gemini 2.5 Flash
                    will automatically generate the most precise query permutations to find your ideal vendors/leads.
                </p>
            </div>
            <form id="linkedinForm">
                <div class="row">
                    <div class="input-group">
                        <label for="li-goal">Describe your business goal & target audience</label>
                        <textarea id="li-goal" name="li-goal" rows="3"
                            placeholder="e.g. We sell hydrogen water machines and want to find vendors, holistic health shop owners, and wellness clinics who would want to sell our products."
                            required
                            style="padding: 0.7rem; font-family: inherit; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary); width: 100%; resize: vertical;"></textarea>
                    </div>
                </div>

                <div class="row">
                    <div class="input-group">
                        <label for="li-location">Location</label>
                        <input type="text" id="li-location" name="li-location" placeholder="e.g. New York, USA"
                            required>
                    </div>

                    <div class="input-group" style="flex: 0.3;">
                        <label for="li-limit">Limit</label>
                        <input type="number" id="li-limit" name="li-limit" value="10" min="1" max="100">
                    </div>
                </div>

                <button type="submit" id="linkedinBtn" class="linkedin-btn">
                    <span class="btn-text" id="linkedinBtnText">Extract LinkedIn Leads</span>
                    <span class="btn-loader loader" id="linkedinBtnLoader"></span>
                </button>
            </form>
        </div>

        <!-- TAB 3: ANALYZE WEBSITES -->
        <div id="tab-analyze" class="tab-content">
            <div class="info-box">
                <p>Upload a generated CSV file to automatically visit every website and use <strong>Gemini 2.5
                        Flash</strong> to write a custom sales pitch/improvement analysis.</p>
            </div>
            <form id="analyzeForm">
                <div class="input-group">
                    <label for="csvFile">Upload Leads CSV (.csv)</label>
                    <input type="file" id="csvFile" name="csvFile" accept=".csv" required
                        style="padding: 0.7rem; font-family: inherit; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary); width: 100%;">
                </div>
                <div class="input-group">
                    <label for="geminiKey">Gemini API Key (Optional)</label>
                    <input type="text" id="geminiKey" name="geminiKey"
                        placeholder="Leave empty to use server default (.env.local)">
                </div>
                <button type="submit" id="analyzeBtn" class="analyze-btn" style="margin-top: 1rem;">
                    <span class="btn-text" id="analyzeBtnText">Analyze Websites</span>
                    <span class="btn-loader loader" id="analyzeBtnLoader"></span>
                </button>
            </form>
        </div>

        <div id="progressSection" class="hidden">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-stats">
                <span id="progressText">0 / 0 Leads</span>
                <span id="latestLead" class="latest-lead">Waiting to start...</span>
            </div>

            <div class="terminal">
                <div class="terminal-header">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                    <span class="terminal-title">Extraction Logs</span>
                </div>
                <div class="terminal-body" id="logWindow">
                    <!-- Logs will appear here -->
                </div>
            </div>
        </div>

        <div id="downloadSection" class="hidden">
            <a href="#" id="downloadLink" class="download-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download CSV
            </a>
            <button id="resetBtn" class="secondary-btn">New Search</button>
        </div>
    </div>

    <script>
        // Tab Switching Logic
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Extract Leads Logic
        const form = document.getElementById('leadForm');
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');

        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const latestLead = document.getElementById('latestLead');
        const logWindow = document.getElementById('logWindow');

        const downloadSection = document.getElementById('downloadSection');
        const downloadLink = document.getElementById('downloadLink');
        const resetBtn = document.getElementById('resetBtn');

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const keyword = document.getElementById('keyword').value;
            const location = document.getElementById('location').value;
            const limit = document.getElementById('limit').value;
            const apiKey = document.getElementById('apiKey').value;
            const requireEmail = document.getElementById('requireEmail').checked;
            const requireWebsite = document.getElementById('requireWebsite').checked;

            form.classList.add('disabled-form');
            generateBtn.classList.add('loading');
            generateBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'block';

            progressSection.classList.remove('hidden');
            downloadSection.classList.add('hidden');

            logWindow.innerHTML = '';
            progressBar.style.width = '0%';
            progressBar.classList.remove('finished');
            progressBar.classList.remove('error');
            progressText.innerText = `0 / ${limit} Leads`;

            const eventSource = new EventSource(`/generate?keyword=${encodeURIComponent(keyword)}&location=${encodeURIComponent(location)}&limit=${limit}&api_key=${encodeURIComponent(apiKey)}&require_email=${requireEmail}&require_website=${requireWebsite}`);

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'log') {
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry';
                    const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    logEl.innerHTML = `<span class="time">[${time}]</span> <span class="msg">${data.message}</span>`;
                    logWindow.appendChild(logEl);
                    logWindow.scrollTop = logWindow.scrollHeight;
                } else if (data.type === 'progress') {
                    const percent = Math.min(100, Math.round((data.count / data.total) * 100));
                    progressBar.style.width = `${percent}%`;
                    progressText.innerText = `${data.count} / ${data.total} Leads`;
                    if (data.latest_lead) {
                        latestLead.innerText = data.latest_lead.length > 30 ? data.latest_lead.substring(0, 30) + '...' : data.latest_lead;
                    }
                } else if (data.type === 'done') {
                    eventSource.close();
                    generateBtn.classList.remove('loading');
                    generateBtn.disabled = false;
                    form.classList.remove('disabled-form');
                    btnText.style.display = 'block';
                    btnLoader.style.display = 'none';

                    progressBar.style.width = '100%';
                    progressBar.classList.add('finished');

                    downloadSection.classList.remove('hidden');
                    downloadLink.href = `/download/${encodeURIComponent(data.filename)}`;
                } else if (data.type === 'error') {
                    eventSource.close();
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry error';
                    logEl.innerHTML = `<span class="time">[ERROR]</span> <span class="msg">${data.message}</span>`;
                    logWindow.appendChild(logEl);
                    logWindow.scrollTop = logWindow.scrollHeight;

                    progressBar.style.width = '100%';
                    progressBar.classList.add('error');

                    generateBtn.classList.remove('loading');
                    generateBtn.disabled = false;
                    form.classList.remove('disabled-form');
                    btnText.style.display = 'block';
                    btnLoader.style.display = 'none';
                }
            };

            eventSource.onerror = function () {
                eventSource.close();
                generateBtn.classList.remove('loading');
                generateBtn.disabled = false;
                form.classList.remove('disabled-form');
                btnText.style.display = 'block';
                btnLoader.style.display = 'none';
            };
        });

        resetBtn.addEventListener('click', () => {
            progressSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
            form.reset();
            analyzeForm.reset();
            progressBar.classList.remove('finished');
            progressBar.classList.remove('error');
        });

        // LinkedIn Leads Logic
        const linkedinForm = document.getElementById('linkedinForm');
        const linkedinBtn = document.getElementById('linkedinBtn');
        const linkedinBtnText = document.getElementById('linkedinBtnText');
        const linkedinBtnLoader = document.getElementById('linkedinBtnLoader');

        linkedinForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const goal = document.getElementById('li-goal').value;
            const location = document.getElementById('li-location').value;
            const limit = document.getElementById('li-limit').value;
            const userApiKey = document.getElementById('apiKey').value; // Reuse system API key logic

            // UI Update
            linkedinForm.classList.add('disabled-form');
            linkedinBtn.classList.add('loading');
            linkedinBtn.disabled = true;
            linkedinBtnText.style.display = 'none';
            linkedinBtnLoader.style.display = 'block';

            progressSection.classList.remove('hidden');
            downloadSection.classList.add('hidden');

            logWindow.innerHTML = '';
            progressBar.style.width = '0%';
            progressBar.classList.remove('finished');
            progressBar.classList.remove('error');
            progressText.innerText = `Analyzing Goal with Gemini AI...`;
            latestLead.innerText = '';

            const eventSource = new EventSource(`/generate_linkedin?goal=${encodeURIComponent(goal)}&location=${encodeURIComponent(location)}&limit=${limit}&api_key=${encodeURIComponent(userApiKey)}`);

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'log') {
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry';
                    const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    logEl.innerHTML = `<span class="time">[${time}]</span> <span class="msg">${data.message}</span>`;
                    logWindow.appendChild(logEl);
                    logWindow.scrollTop = logWindow.scrollHeight;
                } else if (data.type === 'progress') {
                    const percent = Math.min(100, Math.round((data.count / data.total) * 100));
                    progressBar.style.width = `${percent}%`;
                    progressText.innerText = `${data.count} / ${data.total} Profiles`;
                    if (data.latest_lead) {
                        latestLead.innerText = data.latest_lead.length > 30 ? data.latest_lead.substring(0, 30) + '...' : data.latest_lead;
                    }
                } else if (data.type === 'done') {
                    eventSource.close();
                    linkedinBtn.classList.remove('loading');
                    linkedinBtn.disabled = false;
                    linkedinForm.classList.remove('disabled-form');
                    linkedinBtnText.style.display = 'block';
                    linkedinBtnLoader.style.display = 'none';

                    progressBar.style.width = '100%';
                    progressBar.classList.add('finished');

                    downloadSection.classList.remove('hidden');
                    downloadLink.href = `/download/${encodeURIComponent(data.filename)}`;
                    downloadLink.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download LinkedIn XLSX`;
                } else if (data.type === 'error') {
                    eventSource.close();
                    handleError(data.message);
                }
            };

            eventSource.onerror = function () {
                eventSource.close();
                handleError("Connection to server lost.");
            };

            function handleError(msg) {
                const logEl = document.createElement('div');
                logEl.className = 'log-entry error';
                logEl.innerHTML = `<span class="time">[ERROR]</span> <span class="msg">${msg}</span>`;
                logWindow.appendChild(logEl);
                logWindow.scrollTop = logWindow.scrollHeight;

                progressBar.style.width = '100%';
                progressBar.classList.add('error');

                linkedinBtn.classList.remove('loading');
                linkedinBtn.disabled = false;
                linkedinForm.classList.remove('disabled-form');
                linkedinBtnText.style.display = 'block';
                linkedinBtnLoader.style.display = 'none';
            }
        });

        // Analyze Websites Logic
        const analyzeForm = document.getElementById('analyzeForm');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analyzeBtnText = document.getElementById('analyzeBtnText');
        const analyzeBtnLoader = document.getElementById('analyzeBtnLoader');

        analyzeForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('csvFile');
            const geminiKey = document.getElementById('geminiKey').value;

            if (!fileInput.files.length) return;

            // UI Update
            analyzeForm.classList.add('disabled-form');
            analyzeBtn.classList.add('loading');
            analyzeBtn.disabled = true;
            analyzeBtnText.style.display = 'none';
            analyzeBtnLoader.style.display = 'block';

            progressSection.classList.remove('hidden');
            downloadSection.classList.add('hidden');

            logWindow.innerHTML = '';
            progressBar.style.width = '0%';
            progressBar.classList.remove('finished');
            progressBar.classList.remove('error');
            progressText.innerText = `Uploading...`;
            latestLead.innerText = '';

            // 1. Upload File
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const uploadRes = await fetch('/upload_csv', {
                    method: 'POST',
                    body: formData
                });
                const uploadData = await uploadRes.json();

                if (uploadData.error) throw new Error(uploadData.error);

                // 2. Start SSE stream
                const eventSource = new EventSource(`/analyze?filename=${encodeURIComponent(uploadData.filename)}&api_key=${encodeURIComponent(geminiKey)}`);

                eventSource.onmessage = function (event) {
                    const data = JSON.parse(event.data);

                    if (data.type === 'log') {
                        const logEl = document.createElement('div');
                        logEl.className = 'log-entry';
                        const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        logEl.innerHTML = `<span class="time">[${time}]</span> <span class="msg">${data.message}</span>`;
                        logWindow.appendChild(logEl);
                        logWindow.scrollTop = logWindow.scrollHeight;
                    } else if (data.type === 'progress') {
                        const percent = Math.min(100, Math.round((data.count / data.total) * 100));
                        progressBar.style.width = `${percent}%`;
                        progressText.innerText = `${data.count} / ${data.total} Websites`;
                        if (data.latest_lead) {
                            latestLead.innerText = data.latest_lead.length > 30 ? data.latest_lead.substring(0, 30) + '...' : data.latest_lead;
                        }
                    } else if (data.type === 'done') {
                        eventSource.close();
                        analyzeBtn.classList.remove('loading');
                        analyzeBtn.disabled = false;
                        analyzeForm.classList.remove('disabled-form');
                        analyzeBtnText.style.display = 'block';
                        analyzeBtnLoader.style.display = 'none';

                        progressBar.style.width = '100%';
                        progressBar.classList.add('finished');

                        downloadSection.classList.remove('hidden');
                        downloadLink.href = `/download/${encodeURIComponent(data.filename)}`;
                    } else if (data.type === 'error') {
                        throw new Error(data.message);
                    }
                };

                eventSource.onerror = function () {
                    eventSource.close();
                    throw new Error("Connection to server lost.");
                };

            } catch (err) {
                const logEl = document.createElement('div');
                logEl.className = 'log-entry error';
                logEl.innerHTML = `<span class="time">[ERROR]</span> <span class="msg">${err.message}</span>`;
                logWindow.appendChild(logEl);
                logWindow.scrollTop = logWindow.scrollHeight;

                progressBar.style.width = '100%';
                progressBar.classList.add('error');

                analyzeBtn.classList.remove('loading');
                analyzeBtn.disabled = false;
                analyzeForm.classList.remove('disabled-form');
                analyzeBtnText.style.display = 'block';
                analyzeBtnLoader.style.display = 'none';
            }
        });
    </script>
</body>

</html>