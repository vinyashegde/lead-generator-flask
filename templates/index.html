<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Generator Prime</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="animated-bg"></div>
    <div class="glass-container">
        <header>
            <h1>Lead <span class="gradient-text">Generator</span></h1>
            <p class="subtitle">Extract high-quality business leads effortlessly</p>
        </header>

        <form id="leadForm">
            <div class="row">
                <div class="input-group">
                    <label for="keyword">Keyword / Niche</label>
                    <input type="text" id="keyword" name="keyword" placeholder="e.g. Gym equipment" required>
                </div>

                <div class="input-group">
                    <label for="apiKey">SerpAPI Key (Optional)</label>
                    <input type="text" id="apiKey" name="apiKey" placeholder="Leave empty to use default key">
                </div>
            </div>

            <div class="row">
                <div class="input-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" placeholder="e.g. Mumbai" required>
                </div>

                <div class="input-group">
                    <label for="limit">Target Limit</label>
                    <input type="number" id="limit" name="limit" value="10" min="1" max="500" required>
                </div>
            </div>

            <div class="options-group"
                style="display: flex; gap: 1rem; margin-bottom: 1.5rem; color: var(--text-secondary);">
                <label
                    style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.95rem; font-weight: 400; margin: 0;">
                    <input type="checkbox" id="requireWebsite"
                        style="width: 18px; height: 18px; cursor: pointer; padding: 0;">
                    Must have Website
                </label>
                <label
                    style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.95rem; font-weight: 400; margin: 0;">
                    <input type="checkbox" id="requireEmail"
                        style="width: 18px; height: 18px; cursor: pointer; padding: 0;">
                    Must have Email
                </label>
            </div>

            <button type="submit" id="generateBtn">
                <span class="btn-text" id="btnText">Extract Leads</span>
                <span class="btn-loader loader" id="btnLoader"></span>
            </button>
        </form>

        <div id="progressSection" class="hidden">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-stats">
                <span id="progressText">0 / 0 Leads</span>
                <span id="latestLead" class="latest-lead">Waiting to start...</span>
            </div>

            <div class="terminal">
                <div class="terminal-header">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                    <span class="terminal-title">Extraction Logs</span>
                </div>
                <div class="terminal-body" id="logWindow">
                    <!-- Logs will appear here -->
                </div>
            </div>
        </div>

        <div id="downloadSection" class="hidden">
            <a href="#" id="downloadLink" class="download-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download CSV
            </a>
            <button id="resetBtn" class="secondary-btn">New Search</button>
        </div>
    </div>

    <script>
        const form = document.getElementById('leadForm');
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');

        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const latestLead = document.getElementById('latestLead');
        const logWindow = document.getElementById('logWindow');

        const downloadSection = document.getElementById('downloadSection');
        const downloadLink = document.getElementById('downloadLink');
        const resetBtn = document.getElementById('resetBtn');

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const keyword = document.getElementById('keyword').value;
            const location = document.getElementById('location').value;
            const limit = document.getElementById('limit').value;
            const apiKey = document.getElementById('apiKey').value;
            const requireEmail = document.getElementById('requireEmail').checked;
            const requireWebsite = document.getElementById('requireWebsite').checked;

            form.classList.add('disabled-form');
            generateBtn.classList.add('loading');
            generateBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'block';

            progressSection.classList.remove('hidden');
            downloadSection.classList.add('hidden');

            logWindow.innerHTML = '';
            progressBar.style.width = '0%';
            progressBar.classList.remove('finished');
            progressBar.classList.remove('error');
            progressText.innerText = `0 / ${limit} Leads`;

            const eventSource = new EventSource(`/generate?keyword=${encodeURIComponent(keyword)}&location=${encodeURIComponent(location)}&limit=${limit}&api_key=${encodeURIComponent(apiKey)}&require_email=${requireEmail}&require_website=${requireWebsite}`);

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.type === 'log') {
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry';
                    const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    logEl.innerHTML = `<span class="time">[${time}]</span> <span class="msg">${data.message}</span>`;
                    logWindow.appendChild(logEl);
                    logWindow.scrollTop = logWindow.scrollHeight;
                } else if (data.type === 'progress') {
                    const percent = Math.min(100, Math.round((data.count / data.total) * 100));
                    progressBar.style.width = `${percent}%`;
                    progressText.innerText = `${data.count} / ${data.total} Leads`;
                    if (data.latest_lead) {
                        latestLead.innerText = data.latest_lead.length > 30 ? data.latest_lead.substring(0, 30) + '...' : data.latest_lead;
                    }
                } else if (data.type === 'done') {
                    eventSource.close();
                    generateBtn.classList.remove('loading');
                    generateBtn.disabled = false;
                    form.classList.remove('disabled-form');
                    btnText.style.display = 'block';
                    btnLoader.style.display = 'none';

                    progressBar.style.width = '100%';
                    progressBar.classList.add('finished');

                    downloadSection.classList.remove('hidden');
                    downloadLink.href = `/download/${encodeURIComponent(data.filename)}`;
                } else if (data.type === 'error') {
                    eventSource.close();
                    const logEl = document.createElement('div');
                    logEl.className = 'log-entry error';
                    logEl.innerHTML = `<span class="time">[ERROR]</span> <span class="msg">${data.message}</span>`;
                    logWindow.appendChild(logEl);
                    logWindow.scrollTop = logWindow.scrollHeight;

                    progressBar.style.width = '100%';
                    progressBar.classList.add('error');

                    generateBtn.classList.remove('loading');
                    generateBtn.disabled = false;
                    form.classList.remove('disabled-form');
                    btnText.style.display = 'block';
                    btnLoader.style.display = 'none';
                }
            };

            eventSource.onerror = function () {
                eventSource.close();
                generateBtn.classList.remove('loading');
                generateBtn.disabled = false;
                form.classList.remove('disabled-form');
                btnText.style.display = 'block';
                btnLoader.style.display = 'none';
            };
        });

        resetBtn.addEventListener('click', () => {
            progressSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
            form.reset();
            progressBar.classList.remove('finished');
            progressBar.classList.remove('error');
        });
    </script>
</body>

</html>